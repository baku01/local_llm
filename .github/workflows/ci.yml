name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.27.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # Job de anÃ¡lise e testes
  test:
    name: Test & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ” Verify dependencies
      run: flutter pub deps
      
    - name: ğŸ¨ Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        dart format --output=none --set-exit-if-changed . || {
          echo "âŒ Code formatting issues found. Run 'dart format .' to fix."
          exit 1
        }
        echo "âœ… Code formatting is correct"
        
    - name: ğŸ”¬ Analyze code
      run: |
        echo "ğŸ”¬ Running static analysis..."
        flutter analyze --fatal-infos --fatal-warnings || {
          echo "âŒ Static analysis issues found. Please fix the issues above."
          exit 1
        }
        echo "âœ… No static analysis issues found"
        
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        flutter test --coverage --reporter=expanded
        echo "âœ… Unit tests completed"
        
    - name: ğŸ“Š Upload coverage to Codecov
      if: github.event_name == 'push'
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        verbose: true

  # Job de build para mÃºltiplas plataformas
  build:
    name: Build ${{ matrix.platform }}
    needs: test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            os: macos-latest
            build-cmd: 'flutter build macos --release'
            artifact-path: 'build/macos/Build/Products/Release/'
          - platform: windows
            os: windows-latest
            build-cmd: 'flutter build windows --release'
            artifact-path: 'build/windows/x64/runner/Release/'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ”§ Enable desktop support
      run: |
        flutter config --enable-macos-desktop
        flutter config --enable-windows-desktop
        
    - name: ğŸ—ï¸ Build ${{ matrix.platform }}
      run: ${{ matrix.build-cmd }}
      
    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: ${{ matrix.artifact-path }}
        retention-days: 7

  # Job de integraÃ§Ã£o (apenas se todos os outros passarem)
  integration:
    name: Integration Tests
    needs: [test, build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Run integration tests
      run: |
        if [ -d "integration_test" ]; then
          echo "ğŸ§ª Running integration tests..."
          flutter test integration_test/
          echo "âœ… Integration tests completed"
        else
          echo "â„¹ï¸ No integration tests found, skipping..."
        fi

  # Job de qualidade de cÃ³digo
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ” Check for unused dependencies
      run: |
        echo "ğŸ” Checking for unused dependencies..."
        flutter pub deps --json > deps.json
        echo "âœ… Dependencies check completed"
        
    - name: ğŸ“ Check code metrics
      run: |
        echo "ğŸ“ Analyzing code metrics..."
        find lib -name "*.dart" | wc -l | xargs echo "Dart files:"
        find lib -name "*.dart" -exec wc -l {} + | tail -1 | xargs echo "Total lines:"
        echo "âœ… Code metrics analysis completed"