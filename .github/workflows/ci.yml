name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.27.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # Job de anÃ¡lise e testes
  test:
    name: Test & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ” Verify dependencies
      run: flutter pub deps
      
    - name: ðŸŽ¨ Check code formatting
      run: |
        echo "ðŸŽ¨ Checking code formatting..."
        dart format --output=none --set-exit-if-changed . || {
          echo "âŒ Code formatting issues found. Run 'dart format .' to fix."
          exit 1
        }
        echo "âœ… Code formatting is correct"
        
    - name: ðŸ”¬ Analyze code
      run: |
        echo "ðŸ”¬ Running static analysis..."
        flutter analyze --fatal-infos --fatal-warnings || {
          echo "âŒ Static analysis issues found. Please fix the issues above."
          exit 1
        }
        echo "âœ… No static analysis issues found"
        
    - name: ðŸ§ª Run unit tests
      run: |
        echo "ðŸ§ª Running unit tests..."
        flutter test --coverage --reporter=expanded
        echo "âœ… Unit tests completed"
        
    - name: ðŸ“Š Upload coverage to Codecov
      if: github.event_name == 'push'
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        verbose: true

  # Job de build para mÃºltiplas plataformas
  build:
    name: Build ${{ matrix.platform }}
    needs: test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            os: macos-latest
            build-cmd: 'flutter build macos --release'
            artifact-path: 'build/macos/Build/Products/Release/'
          - platform: windows
            os: windows-latest
            build-cmd: 'flutter build windows --release'
            artifact-path: 'build/windows/x64/runner/Release/'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Enable desktop support
      run: |
        flutter config --enable-macos-desktop
        flutter config --enable-windows-desktop
        
    - name: ðŸ—ï¸ Build ${{ matrix.platform }}
      run: ${{ matrix.build-cmd }}
      
    - name: ðŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: ${{ matrix.artifact-path }}
        retention-days: 7

  # Job de integraÃ§Ã£o (apenas se todos os outros passarem)
  integration:
    name: Integration Tests
    needs: [test, build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ§ª Run integration tests
      run: |
        if [ -d "integration_test" ]; then
          echo "ðŸ§ª Running integration tests..."
          flutter test integration_test/
          echo "âœ… Integration tests completed"
        else
          echo "â„¹ï¸ No integration tests found, skipping..."
        fi

  # Job de qualidade de cÃ³digo
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ” Check for unused dependencies
      run: |
        echo "ðŸ” Checking for unused dependencies..."
        flutter pub deps --json > deps.json
        echo "âœ… Dependencies check completed"
        
    - name: ðŸ“ Check code metrics
      run: |
        echo "ðŸ“ Analyzing code metrics..."
        find lib -name "*.dart" | wc -l | xargs echo "Dart files:"
        find lib -name "*.dart" -exec wc -l {} + | tail -1 | xargs echo "Total lines:"
        echo "âœ… Code metrics analysis completed"

  # Job de status final para release
  ci_status:
    name: CI Status
    needs: [test, build, integration, quality]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    outputs:
      success: ${{ steps.status.outputs.success }}
      
    steps:
    - name: ðŸ“Š Determine CI Status
      id: status
      run: |
        # Verificar se todos os jobs necessÃ¡rios passaram
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… CI Pipeline completed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ CI Pipeline failed"
        fi
        
    - name: ðŸ“‹ CI Summary
      run: |
        echo "## ðŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Test**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Integration**: ${{ needs.integration.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality**: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.status.outputs.success }}" = "true" ]; then
          echo "ðŸŽ‰ **Status**: Ready for Release!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status**: Issues found, release blocked" >> $GITHUB_STEP_SUMMARY
        fi