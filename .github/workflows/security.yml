name: Security & Dependencies

on:
  schedule:
    # Executa toda segunda-feira Ã s 9:00 UTC
    - cron: '0 9 * * 1'
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Check for outdated dependencies
      run: |
        echo "ğŸ“¦ Verificando dependÃªncias desatualizadas..."
        flutter pub outdated || true
        
    - name: Audit dependencies
      run: |
        echo "ğŸ” Auditando dependÃªncias..."
        dart pub deps --style=compact
        
    - name: Check for unused dependencies
      run: |
        echo "ğŸ§¹ Verificando dependÃªncias nÃ£o utilizadas..."
        flutter pub deps --unused || true

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run detailed analysis
      run: |
        echo "ğŸ” Executando anÃ¡lise detalhada do cÃ³digo..."
        dart analyze --verbose
        
    - name: Check code metrics
      run: |
        echo "ğŸ“Š Verificando mÃ©tricas do cÃ³digo..."
        find lib -name '*.dart' -exec wc -l {} + | sort -n
        echo "ğŸ“ Estrutura do projeto:"
        tree lib/ -I '__pycache__|*.pyc|node_modules' || find lib -type f -name '*.dart' | head -20
        
    - name: Verify Clean Architecture
      run: |
        echo "ğŸ›ï¸ Verificando aderÃªncia Ã  Clean Architecture..."
        echo "Domain layer files:"
        find lib/domain -name '*.dart' | wc -l
        echo "Data layer files:"
        find lib/data -name '*.dart' | wc -l
        echo "Presentation layer files:"
        find lib/presentation -name '*.dart' | wc -l
        echo "Core layer files:"
        find lib/core -name '*.dart' | wc -l

  performance-check:
    name: Performance Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Build size analysis
      run: |
        echo "ğŸ“ Analisando tamanho do build..."
        flutter build linux --release --analyze-size
        
    - name: Check for performance anti-patterns
      run: |
        echo "âš¡ Verificando anti-padrÃµes de performance..."
        # Procura por possÃ­veis problemas de performance
        echo "Verificando uso de setState desnecessÃ¡rio:"
        grep -r "setState" lib/ --include="*.dart" | wc -l || true
        echo "Verificando widgets nÃ£o const:"
        grep -r "Widget build" lib/ --include="*.dart" | grep -v "const" | wc -l || true
        
  documentation-check:
    name: Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check documentation coverage
      run: |
        echo "ğŸ“š Verificando cobertura de documentaÃ§Ã£o..."
        echo "Arquivos Dart com documentaÃ§Ã£o:"
        grep -r "///" lib/ --include="*.dart" | cut -d: -f1 | sort | uniq | wc -l || true
        echo "Total de arquivos Dart:"
        find lib/ -name "*.dart" | wc -l
        
    - name: Verify README completeness
      run: |
        echo "ğŸ“– Verificando completude do README..."
        if [ -f README.md ]; then
          echo "âœ… README.md existe"
          echo "SeÃ§Ãµes encontradas:"
          grep "^#" README.md | head -10
          echo "Tamanho do README: $(wc -l < README.md) linhas"
        else
          echo "âŒ README.md nÃ£o encontrado"
          exit 1
        fi
        
    - name: Check for TODO comments
      run: |
        echo "ğŸ“ Verificando comentÃ¡rios TODO pendentes..."
        grep -r "TODO\|FIXME\|HACK" lib/ --include="*.dart" || echo "âœ… Nenhum TODO encontrado"

  security-summary:
    name: Security Summary
    needs: [dependency-check, code-quality, performance-check, documentation-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Security Report
      run: |
        echo "ğŸ›¡ï¸ RELATÃ“RIO DE SEGURANÃ‡A E QUALIDADE"
        echo "======================================"
        echo "âœ… VerificaÃ§Ã£o de dependÃªncias: ${{ needs.dependency-check.result }}"
        echo "âœ… AnÃ¡lise de qualidade: ${{ needs.code-quality.result }}"
        echo "âœ… VerificaÃ§Ã£o de performance: ${{ needs.performance-check.result }}"
        echo "âœ… VerificaÃ§Ã£o de documentaÃ§Ã£o: ${{ needs.documentation-check.result }}"
        echo ""
        echo "ğŸ“Š Status geral: $(if [ '${{ needs.dependency-check.result }}' = 'success' ] && [ '${{ needs.code-quality.result }}' = 'success' ] && [ '${{ needs.performance-check.result }}' = 'success' ] && [ '${{ needs.documentation-check.result }}' = 'success' ]; then echo 'ğŸŸ¢ APROVADO'; else echo 'ğŸ”´ REQUER ATENÃ‡ÃƒO'; fi)"
        echo "ğŸ•’ Data da verificaÃ§Ã£o: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"