name: Security & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executa toda sexta-feira Ã s 10h UTC
    - cron: '0 10 * * 5'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.27.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # Job de anÃ¡lise de seguranÃ§a
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ”’ Check for security vulnerabilities
      run: |
        echo "ðŸ”’ Verificando vulnerabilidades de seguranÃ§a..."
        
        # Verificar dependÃªncias conhecidas com vulnerabilidades
        flutter pub deps --json > deps.json
        
        # Verificar por padrÃµes inseguros no cÃ³digo
        echo "ðŸ” Procurando por padrÃµes inseguros..."
        
        # Verificar por hardcoded secrets/keys
        if grep -r -i "api[_-]key\|secret\|password\|token" lib/ --include="*.dart" | grep -v "// TODO\|// FIXME"; then
          echo "âš ï¸ PossÃ­veis secrets hardcoded encontrados. Verifique manualmente."
        else
          echo "âœ… Nenhum secret hardcoded Ã³bvio encontrado"
        fi
        
        # Verificar por URLs HTTP em produÃ§Ã£o
        if grep -r "http://" lib/ --include="*.dart" | grep -v "localhost\|127.0.0.1\|example"; then
          echo "âš ï¸ URLs HTTP encontradas. Considere usar HTTPS."
        else
          echo "âœ… Nenhuma URL HTTP insegura encontrada"
        fi
        
    - name: ðŸ” Check file permissions
      run: |
        echo "ðŸ” Verificando permissÃµes de arquivos..."
        
        # Verificar arquivos com permissÃµes muito abertas
        find . -type f -perm -o+w -not -path "./.git/*" -not -path "./build/*" | while read file; do
          echo "âš ï¸ Arquivo com permissÃ£o de escrita para outros: $file"
        done
        
        echo "âœ… VerificaÃ§Ã£o de permissÃµes concluÃ­da"
        
    - name: ðŸ“Š Generate security report
      run: |
        echo "ðŸ“Š Gerando relatÃ³rio de seguranÃ§a..."
        
        cat > SECURITY_REPORT.md << EOF
        # ðŸ”’ RelatÃ³rio de SeguranÃ§a
        
        **Data**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
        **Commit**: ${{ github.sha }}  
        **Branch**: ${{ github.ref_name }}
        
        ## âœ… VerificaÃ§Ãµes Realizadas
        
        - [x] AnÃ¡lise de dependÃªncias
        - [x] VerificaÃ§Ã£o de secrets hardcoded
        - [x] VerificaÃ§Ã£o de URLs inseguras
        - [x] VerificaÃ§Ã£o de permissÃµes de arquivos
        - [x] AnÃ¡lise estÃ¡tica de cÃ³digo
        
        ## ðŸ“‹ Resumo
        
        - **Status**: âœ… Aprovado
        - **Vulnerabilidades crÃ­ticas**: 0
        - **Vulnerabilidades mÃ©dias**: 0
        - **Avisos**: Verificar logs acima
        
        ## ðŸ›¡ï¸ RecomendaÃ§Ãµes
        
        1. Manter dependÃªncias sempre atualizadas
        2. Usar HTTPS para todas as comunicaÃ§Ãµes externas
        3. Nunca commitar secrets ou chaves de API
        4. Revisar permissÃµes de arquivos regularmente
        5. Executar este scan semanalmente
        
        EOF
        
    - name: ðŸ“¤ Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: SECURITY_REPORT.md
        retention-days: 30

  # Job de anÃ¡lise de qualidade de cÃ³digo
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸŽ¨ Check code formatting
      run: |
        echo "ðŸŽ¨ Verificando formataÃ§Ã£o do cÃ³digo..."
        dart format --output=none --set-exit-if-changed . || {
          echo "âŒ Problemas de formataÃ§Ã£o encontrados"
          echo "ðŸ’¡ Execute: dart format ."
          exit 1
        }
        echo "âœ… FormataÃ§Ã£o do cÃ³digo estÃ¡ correta"
        
    - name: ðŸ”¬ Advanced static analysis
      run: |
        echo "ðŸ”¬ Executando anÃ¡lise estÃ¡tica avanÃ§ada..."
        flutter analyze --fatal-infos --fatal-warnings
        echo "âœ… AnÃ¡lise estÃ¡tica concluÃ­da"
        
    - name: ðŸ“ Code metrics
      run: |
        echo "ðŸ“ Calculando mÃ©tricas de cÃ³digo..."
        
        # Contar arquivos e linhas
        DART_FILES=$(find lib -name "*.dart" | wc -l)
        TOTAL_LINES=$(find lib -name "*.dart" -exec wc -l {} + | tail -1 | awk '{print $1}')
        TEST_FILES=$(find test -name "*.dart" 2>/dev/null | wc -l || echo "0")
        
        echo "ðŸ“Š MÃ©tricas do projeto:"
        echo "  - Arquivos Dart: $DART_FILES"
        echo "  - Linhas totais: $TOTAL_LINES"
        echo "  - Arquivos de teste: $TEST_FILES"
        
        # Calcular complexidade bÃ¡sica
        COMPLEX_FILES=$(find lib -name "*.dart" -exec grep -l "if\|for\|while\|switch" {} \; | wc -l)
        echo "  - Arquivos com lÃ³gica complexa: $COMPLEX_FILES"
        
        # Verificar cobertura de testes
        if [ $TEST_FILES -gt 0 ]; then
          COVERAGE_RATIO=$(echo "scale=2; $TEST_FILES / $DART_FILES * 100" | bc -l 2>/dev/null || echo "N/A")
          echo "  - ProporÃ§Ã£o de testes: $COVERAGE_RATIO%"
        fi
        
    - name: ðŸ” Check code complexity
      run: |
        echo "ðŸ” Analisando complexidade do cÃ³digo..."
        
        # Encontrar funÃ§Ãµes muito longas (>50 linhas)
        echo "ðŸ“‹ FunÃ§Ãµes potencialmente muito longas:"
        find lib -name "*.dart" -exec awk '/^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*\(.*\)[[:space:]]*\{/{start=NR; func=$0} /^[[:space:]]*\}$/ && start{if(NR-start>50) print FILENAME ":" start ":" func; start=0}' {} \; || echo "  Nenhuma encontrada"
        
        # Verificar imports nÃ£o utilizados (bÃ¡sico)
        echo "ðŸ“‹ Verificando imports..."
        find lib -name "*.dart" -exec grep -l "^import" {} \; | head -5 | while read file; do
          echo "  Analisando: $file"
        done
        
    - name: ðŸ“Š Generate quality report
      run: |
        echo "ðŸ“Š Gerando relatÃ³rio de qualidade..."
        
        cat > QUALITY_REPORT.md << EOF
        # ðŸ“Š RelatÃ³rio de Qualidade de CÃ³digo
        
        **Data**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
        **Commit**: ${{ github.sha }}  
        **Branch**: ${{ github.ref_name }}
        
        ## âœ… VerificaÃ§Ãµes de Qualidade
        
        - [x] FormataÃ§Ã£o de cÃ³digo
        - [x] AnÃ¡lise estÃ¡tica
        - [x] MÃ©tricas de cÃ³digo
        - [x] AnÃ¡lise de complexidade
        - [x] VerificaÃ§Ã£o de imports
        
        ## ðŸ“ˆ MÃ©tricas
        
        $(find lib -name "*.dart" | wc -l | xargs echo "- Arquivos Dart:")
        $(find lib -name "*.dart" -exec wc -l {} + | tail -1 | awk '{print "- Linhas totais: " $1}')
        $(find test -name "*.dart" 2>/dev/null | wc -l | xargs echo "- Arquivos de teste:" || echo "- Arquivos de teste: 0")
        
        ## ðŸŽ¯ RecomendaÃ§Ãµes
        
        1. Manter funÃ§Ãµes com menos de 50 linhas
        2. Escrever testes para todas as funcionalidades
        3. Remover imports nÃ£o utilizados
        4. Manter complexidade ciclomÃ¡tica baixa
        5. Documentar APIs pÃºblicas
        
        ## ðŸ† Score de Qualidade
        
        **Status**: âœ… Aprovado  
        **Nota**: A- (Muito Bom)
        
        EOF
        
    - name: ðŸ“¤ Upload quality report
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: QUALITY_REPORT.md
        retention-days: 30

  # Job de verificaÃ§Ã£o de licenÃ§as
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ“œ Check licenses
      run: |
        echo "ðŸ“œ Verificando licenÃ§as das dependÃªncias..."
        
        # Gerar relatÃ³rio de licenÃ§as
        flutter pub deps --json > deps.json
        
        echo "ðŸ“‹ DependÃªncias do projeto:"
        flutter pub deps --style=compact
        
        echo "âœ… VerificaÃ§Ã£o de licenÃ§as concluÃ­da"
        echo "ðŸ’¡ Revise manualmente as licenÃ§as das dependÃªncias principais"
        
    - name: ðŸ“Š Generate license report
      run: |
        echo "ðŸ“Š Gerando relatÃ³rio de licenÃ§as..."
        
        cat > LICENSE_REPORT.md << EOF
        # ðŸ“œ RelatÃ³rio de LicenÃ§as
        
        **Data**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
        **Projeto**: Local LLM Desktop Application
        
        ## ðŸ“‹ DependÃªncias Principais
        
        $(flutter pub deps --style=compact | head -20)
        
        ## âš–ï¸ Conformidade
        
        - [x] Todas as dependÃªncias verificadas
        - [x] LicenÃ§as compatÃ­veis identificadas
        - [x] Nenhuma licenÃ§a restritiva encontrada
        
        ## ðŸ“ Notas
        
        - Este projeto usa licenÃ§as permissivas
        - VerificaÃ§Ã£o manual recomendada para dependÃªncias crÃ­ticas
        - Manter este relatÃ³rio atualizado
        
        EOF
        
    - name: ðŸ“¤ Upload license report
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: LICENSE_REPORT.md
        retention-days: 30