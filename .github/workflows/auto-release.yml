name: Auto Release

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [main]

env:
  FLUTTER_VERSION: '3.27.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # Job para verificar se deve fazer release apÃ³s CI bem-sucedido
  check_and_release:
    name: Check and Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ” Check if release is needed
      id: check
      run: |
        # Obter commits desde Ãºltimo tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "No previous tags found, checking recent commits"
          COMMITS_TO_CHECK=$(git log HEAD~10..HEAD --pretty=format:"%s")
        else
          COMMITS_TO_CHECK=$(git log $LAST_TAG..HEAD --pretty=format:"%s")
        fi
        
        echo "Commits to check:"
        echo "$COMMITS_TO_CHECK"
        
        # Verificar se atual commit jÃ¡ Ã© uma tag
        if git describe --tags --exact-match HEAD 2>/dev/null; then
          echo "Current commit is already tagged, skipping release"
          echo "should_release=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Verificar conventional commits
        SHOULD_RELEASE="false"
        VERSION_BUMP="patch"
        
        if echo "$COMMITS_TO_CHECK" | grep -qE "^(feat|fix|perf)(\(.+\))?: .+"; then
          SHOULD_RELEASE="true"
          
          if echo "$COMMITS_TO_CHECK" | grep -qE "^feat(\(.+\))?: .+"; then
            VERSION_BUMP="minor"
          fi
          
          if echo "$COMMITS_TO_CHECK" | grep -qE "BREAKING CHANGE|^feat(\(.+\))?!: |^fix(\(.+\))?!: "; then
            VERSION_BUMP="major"
          fi
        fi
        
        echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
        echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Should release: $SHOULD_RELEASE"
        echo "ğŸ“ˆ Version bump: $VERSION_BUMP"
        
    - name: ğŸš€ Trigger Release Workflow
      if: steps.check.outputs.should_release == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const versionBump = '${{ steps.check.outputs.version_bump }}';
          
          console.log(`Triggering release workflow with version bump: ${versionBump}`);
          
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'release.yml',
            ref: 'main',
            inputs: {
              release_type: versionBump
            }
          });
          
          console.log('âœ… Release workflow triggered successfully');
          
    - name: ğŸ“¢ No Release Needed
      if: steps.check.outputs.should_release == 'false'
      run: |
        echo "â„¹ï¸ No release needed - no significant changes detected"
        echo "ğŸ’¡ To trigger a release manually, use workflow_dispatch on the Release workflow"