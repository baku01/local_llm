name: Dependency Management

on:
  schedule:
    # Executa toda segunda-feira Ã s 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Tipo de atualizaÃ§Ã£o'
        required: true
        default: 'minor'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  FLUTTER_VERSION: '3.24.3'
  FLUTTER_CHANNEL: 'stable'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“Š Check current dependencies
      run: |
        echo "ğŸ“Š Current dependencies:"
        flutter pub deps --style=compact
        
    - name: ğŸ”„ Update Flutter SDK
      run: |
        echo "ğŸ”„ Updating Flutter SDK..."
        flutter upgrade
        flutter --version
        
    - name: ğŸ“¦ Update dependencies
      run: |
        echo "ğŸ“¦ Updating dependencies..."
        flutter pub upgrade
        
    - name: ğŸ§ª Run tests after update
      run: |
        echo "ğŸ§ª Running tests to verify updates..."
        flutter pub get
        flutter test --reporter=expanded
        
    - name: ğŸ” Check for security vulnerabilities
      run: |
        echo "ğŸ” Checking for security vulnerabilities..."
        flutter pub deps --json > deps.json
        # Aqui vocÃª pode adicionar ferramentas de seguranÃ§a especÃ­ficas
        
    - name: ğŸ“‹ Generate update summary
      id: summary
      run: |
        echo "ğŸ“‹ Generating update summary..."
        if git diff --quiet pubspec.lock; then
          echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          echo "SUMMARY=Nenhuma atualizaÃ§Ã£o de dependÃªncia disponÃ­vel" >> $GITHUB_OUTPUT
        else
          echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          CHANGED_DEPS=$(git diff pubspec.lock | grep -E '^[+-]' | grep -v '^[+-]{3}' | wc -l)
          echo "SUMMARY=Atualizadas $CHANGED_DEPS dependÃªncias" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“ Create detailed changelog
      if: steps.summary.outputs.HAS_CHANGES == 'true'
      run: |
        echo "ğŸ“ Creating detailed changelog..."
        echo "## ğŸ“¦ AtualizaÃ§Ãµes de DependÃªncias" > DEPENDENCY_CHANGELOG.md
        echo "" >> DEPENDENCY_CHANGELOG.md
        echo "### AlteraÃ§Ãµes no pubspec.lock:" >> DEPENDENCY_CHANGELOG.md
        echo "\`\`\`diff" >> DEPENDENCY_CHANGELOG.md
        git diff pubspec.lock >> DEPENDENCY_CHANGELOG.md
        echo "\`\`\`" >> DEPENDENCY_CHANGELOG.md
        echo "" >> DEPENDENCY_CHANGELOG.md
        echo "### VerificaÃ§Ãµes realizadas:" >> DEPENDENCY_CHANGELOG.md
        echo "- âœ… Testes unitÃ¡rios executados com sucesso" >> DEPENDENCY_CHANGELOG.md
        echo "- âœ… AnÃ¡lise de seguranÃ§a realizada" >> DEPENDENCY_CHANGELOG.md
        echo "- âœ… Compatibilidade verificada" >> DEPENDENCY_CHANGELOG.md
        
    - name: ğŸ”€ Create Pull Request
      if: steps.summary.outputs.HAS_CHANGES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: atualizar dependÃªncias Flutter
          
          ${{ steps.summary.outputs.SUMMARY }}
          
          - AtualizaÃ§Ãµes testadas e verificadas
          - Compatibilidade confirmada
          - Testes passando
        title: 'ğŸ“¦ AtualizaÃ§Ã£o AutomÃ¡tica de DependÃªncias'
        body-path: DEPENDENCY_CHANGELOG.md
        branch: chore/update-dependencies
        delete-branch: true
        labels: |
          dependencies
          automated
          chore
        reviewers: |
          ${{ github.repository_owner }}
        
    - name: ğŸ“¢ Notify if no updates
      if: steps.summary.outputs.HAS_CHANGES == 'false'
      run: |
        echo "ğŸ“¢ Nenhuma atualizaÃ§Ã£o de dependÃªncia necessÃ¡ria."
        echo "âœ… Todas as dependÃªncias estÃ£o atualizadas!"

  # Job para verificar dependÃªncias obsoletas
  check-outdated:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ” Check for outdated packages
      run: |
        echo "ğŸ” Verificando pacotes desatualizados..."
        flutter pub outdated --json > outdated.json || true
        
        if [ -s outdated.json ]; then
          echo "ğŸ“‹ Pacotes desatualizados encontrados:"
          cat outdated.json
        else
          echo "âœ… Todos os pacotes estÃ£o atualizados!"
        fi
        
    - name: ğŸ“Š Upload outdated report
      uses: actions/upload-artifact@v4
      with:
        name: outdated-dependencies-report
        path: outdated.json
        retention-days: 30