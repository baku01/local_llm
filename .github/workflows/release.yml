name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do release (ex: v1.0.0)'
        required: true
        type: string

env:
  FLUTTER_VERSION: '3.27.0'
  FLUTTER_CHANNEL: 'stable'

jobs:
  # Job de preparaÃ§Ã£o e validaÃ§Ã£o
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ·ï¸ Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "tag=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Version: $VERSION"
        
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ§ª Run tests
      run: |
        echo "ðŸ§ª Running tests before release..."
        flutter test --reporter=expanded
        echo "âœ… All tests passed!"
        
    - name: ðŸ” Validate version
      run: |
        echo "ðŸ” Validating version in pubspec.yaml..."
        PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
        echo "Pubspec version: $PUBSPEC_VERSION"
        echo "Tag version: ${{ steps.version.outputs.version }}"
        
        if [ "$PUBSPEC_VERSION" != "${{ steps.version.outputs.version }}" ]; then
          echo "âŒ Version mismatch between tag and pubspec.yaml"
          exit 1
        fi
        echo "âœ… Version validation passed!"

  # Job de build para todas as plataformas
  build:
    name: Build ${{ matrix.platform }}
    needs: prepare
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos
            os: macos-latest
            build-cmd: 'flutter build macos --release'
            artifact-name: 'local_llm-macos'
            artifact-path: 'build/macos/Build/Products/Release/'
            archive-cmd: 'cd build/macos/Build/Products/Release && zip -r ../../../../../local_llm-macos.zip local_llm.app'
            archive-file: 'local_llm-macos.zip'
          - platform: windows
            os: windows-latest
            build-cmd: 'flutter build windows --release'
            artifact-name: 'local_llm-windows'
            artifact-path: 'build/windows/x64/runner/Release/'
            archive-cmd: 'cd build/windows/x64/runner/Release && 7z a ../../../../../local_llm-windows.zip *'
            archive-file: 'local_llm-windows.zip'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.FLUTTER_CHANNEL }}
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Enable desktop support
      run: |
        flutter config --enable-macos-desktop
        flutter config --enable-windows-desktop
        
    - name: ðŸ—ï¸ Build ${{ matrix.platform }}
      run: ${{ matrix.build-cmd }}
      
    - name: ðŸ“¦ Create archive
      run: ${{ matrix.archive-cmd }}
      
    - name: ðŸ“¤ Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.archive-file }}
        retention-days: 90

  # Job de criaÃ§Ã£o do release
  release:
    name: Create Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: ðŸ“‹ Generate changelog
      id: changelog
      run: |
        echo "ðŸ“‹ Generating changelog..."
        
        # Obter a tag anterior
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ðŸ“Š Changes since $PREVIOUS_TAG:"
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          echo "ðŸ“Š Initial release"
          CHANGELOG="- Initial release of Local LLM Desktop Application"
        fi
        
        # Criar changelog formatado
        cat > CHANGELOG.md << EOF
        ## ðŸš€ Local LLM v${{ needs.prepare.outputs.version }}
        
        ### ðŸ“± AplicaÃ§Ã£o Desktop para LLMs Locais
        
        Esta versÃ£o inclui:
        
        ### ðŸ”„ MudanÃ§as:
        $CHANGELOG
        
        ### ðŸ“¦ Downloads DisponÃ­veis:
        - **macOS**: local_llm-macos.zip
        - **Windows**: local_llm-windows.zip
        
        ### ðŸ“‹ Requisitos do Sistema:
        - **macOS**: macOS 10.14 ou superior
        - **Windows**: Windows 10 ou superior
        - **Ollama**: NecessÃ¡rio para executar modelos LLM locais
        
        ### ðŸ› ï¸ InstalaÃ§Ã£o:
        1. Baixe o arquivo correspondente ao seu sistema operacional
        2. Extraia o arquivo
        3. Execute o aplicativo
        4. Certifique-se de que o Ollama estÃ¡ instalado e rodando
        
        ### ðŸ› Problemas Conhecidos:
        - Consulte as [Issues](https://github.com/${{ github.repository }}/issues) para problemas conhecidos
        
        ---
        
        **VersÃ£o completa**: ${{ needs.prepare.outputs.tag }}  
        **Data de build**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
        **Commit**: ${{ github.sha }}
        EOF
        
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.tag }}
        name: 'Local LLM v${{ needs.prepare.outputs.version }}'
        body_path: CHANGELOG.md
        draft: false
        prerelease: ${{ contains(needs.prepare.outputs.version, '-') }}
        files: |
          artifacts/local_llm-macos/local_llm-macos.zip
          artifacts/local_llm-windows/local_llm-windows.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“¢ Release Summary
      run: |
        echo "ðŸŽ‰ Release criado com sucesso!"
        echo "ðŸ“‹ Tag: ${{ needs.prepare.outputs.tag }}"
        echo "ðŸ“¦ VersÃ£o: ${{ needs.prepare.outputs.version }}"
        echo "ðŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}"

  # Job de notificaÃ§Ã£o pÃ³s-release
  notify:
    name: Post-Release Notifications
    needs: [prepare, release]
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    
    steps:
    - name: ðŸ“¢ Success notification
      run: |
        echo "âœ… Release ${{ needs.prepare.outputs.tag }} criado com sucesso!"
        echo "ðŸŽ¯ PrÃ³ximos passos:"
        echo "  - Verificar downloads funcionando"
        echo "  - Atualizar documentaÃ§Ã£o se necessÃ¡rio"
        echo "  - Comunicar release aos usuÃ¡rios"